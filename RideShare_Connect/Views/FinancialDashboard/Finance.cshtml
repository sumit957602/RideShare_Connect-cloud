@model RideShare_Connect.ViewModels.FinanceViewModel
@{
    ViewData["Title"] = "Payment & Financial";
}

<head>
    <link rel="stylesheet" href="~/css/finance.css" asp-append-version="true" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

    <!-- Header & Navbar from Main Site -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fs-4" href="#">
                <i class="bi bi-car-front-fill me-2" style="color: var(--secondary-color);"></i>RideShare Connect
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">

                    <li class="nav-item">
                        <a class="nav-link" href="../../UserDashboard/User">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Payments & Finance</a>
                    </li>
                </ul>
                <div class="dropdown ms-lg-3">
                    <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="@Model.Profile?.ProfilePicture" alt="Profile" width="32" height="32" class="rounded-circle me-2">
                        <strong>@Model.Profile?.FullName</strong>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                        <li><a class="dropdown-item" href="../../UserDashboard/UserProfile">Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form asp-controller="UserAccount" asp-action="Logout" method="post" class="d-inline">
                                <button type="submit" class="dropdown-item">Sign out</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content: Payments & Financial Management -->
    <main class="flex-grow-1 py-5">
        <div class="container">
            <div class="row g-4">
                <!-- Left Sidebar Navigation -->
                <div class="col-lg-3">
                    <div class="card h-100 sticky-top" style="top: 100px; z-index: 1;">
                        <div class="card-body p-4">
                            <h6 class="text-uppercase text-muted fw-bold mb-4 small ls-1">Financial Menu</h6>
                            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                                <button class="nav-link active text-start" id="v-pills-wallet-tab" data-bs-toggle="pill" data-bs-target="#v-pills-wallet" type="button" role="tab" aria-controls="v-pills-wallet" aria-selected="true"><i class="bi bi-pie-chart-fill me-3"></i>Overview</button>
                                <button class="nav-link text-start" id="v-pills-methods-tab" data-bs-toggle="pill" data-bs-target="#v-pills-methods" type="button" role="tab" aria-controls="v-pills-methods" aria-selected="false"><i class="bi bi-credit-card-2-front-fill me-3"></i>Cards & Methods</button>
                                <button class="nav-link text-start" id="v-pills-history-tab" data-bs-toggle="pill" data-bs-target="#v-pills-history" type="button" role="tab" aria-controls="v-pills-history" aria-selected="false"><i class="bi bi-clock-history me-3"></i>Transactions</button>
                                <button class="nav-link text-start" id="v-pills-refunds-tab" data-bs-toggle="pill" data-bs-target="#v-pills-refunds" type="button" role="tab" aria-controls="v-pills-refunds" aria-selected="false"><i class="bi bi-arrow-counterclockwise me-3"></i>Refunds</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Content Area -->
                <div class="col-lg-9">
                    <div class="tab-content" id="v-pills-tabContent">
                        
                        <!-- Wallet & Financial Reports Dashboard Tab -->
                        <div class="tab-pane fade show active" id="v-pills-wallet" role="tabpanel" aria-labelledby="v-pills-wallet-tab" tabindex="0">
                            <div class="row g-4 mb-4">
                                <div class="col-lg-12">
                                    <div class="card wallet-card h-100">
                                        <div class="card-body p-5 d-flex flex-column justify-content-between">
                                            <div class="d-flex justify-content-between align-items-start position-relative">
                                                <div>
                                                    <p class="mb-1 text-white-50 text-uppercase ls-1 small">Total Wallet Balance</p>
                                                    <h1 class="wallet-balance mb-0">₹@Model.WalletBalance.ToString("N2")</h1>
                                                </div>
                                                <div class="icon-shape bg-white bg-opacity-10 rounded-circle text-white p-3">
                                                    <i class="bi bi-wallet2 fs-3"></i>
                                                </div>
                                            </div>
                                            <div class="mt-4 pt-3 border-top border-white border-opacity-10 d-flex justify-content-between align-items-center position-relative">
                                                <div class="text-white-50 small">
                                                    Updated: @DateTime.Now.ToString("MMM dd, yyyy")
                                                </div>
                                                <button class="btn btn-light rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addMoneyModal">
                                                    <i class="bi bi-plus-lg me-2"></i>Add Money
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="card stat-card h-100">
                                        <div class="card-body p-4">
                                            <div class="stat-icon bg-orange-subtle mb-3">
                                                <i class="bi bi-graph-up-arrow"></i>
                                            </div>
                                            <p class="text-muted mb-1 text-uppercase small fw-bold">Spent This Month</p>
                                            <h3 class="fw-bold mb-0 text-dark">₹@Model.TotalSpentThisMonth.ToString("N2")</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card stat-card h-100">
                                        <div class="card-body p-4">
                                            <div class="stat-icon bg-green-subtle mb-3">
                                                <i class="bi bi-piggy-bank"></i>
                                            </div>
                                            <p class="text-muted mb-1 text-uppercase small fw-bold">Total Saved on Rides</p>
                                            <h3 class="fw-bold mb-0 text-success">₹@Model.TotalSavedOnRides.ToString("N2")</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header bg-transparent border-bottom px-4 py-3 d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0 fw-bold">Recent Transactions</h5>
                                    <button class="btn btn-sm btn-link text-decoration-none fw-medium" onclick="document.getElementById('v-pills-history-tab').click()">See All <i class="bi bi-arrow-right ms-1"></i></button>
                                </div>
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush">
                                        @if (Model.RecentTransactions.Any())
                                        {
                                            foreach (var txn in Model.RecentTransactions)
                                            {
                                                var isCredit = txn.TxnType?.ToLower() == "credit";
                                                var isSuccessful = txn.Status?.ToLower() == "successful";
                                                
                                                <li class="list-group-item transaction-list-item d-flex align-items-center px-4 py-3 border-bottom-0">
                                                    <div class="icon-shape icon-md rounded-circle @(isSuccessful ? (isCredit ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger") : "bg-secondary-subtle text-secondary") me-3" style="width: 48px; height: 48px; min-width: 48px;">
                                                        @if(isSuccessful)
                                                        {
                                                            <i class="bi @(isCredit ? "bi-arrow-down-left" : "bi-arrow-up-right") fs-5"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="bi bi-exclamation-lg fs-5"></i>
                                                        }
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1 fw-bold text-dark">@txn.Description</h6>
                                                        <small class="text-muted">@txn.TxnDate.ToString("MMM dd, yyyy • hh:mm tt")</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <h6 class="mb-1 fw-bold @(isSuccessful ? (isCredit ? "text-success" : "text-danger") : "text-muted")">
                                                            @(isCredit ? "+" : "-")@Html.Raw("&#8377;")@txn.Amount.ToString("N2")
                                                        </h6>
                                                        <span class="badge @(isSuccessful ? "bg-success-subtle text-success" : "bg-warning-subtle text-warning-emphasis") rounded-pill border border-0 px-2 py-1" style="font-size: 0.7rem; font-weight: 600;">
                                                            @txn.Status.ToUpper()
                                                        </span>
                                                    </div>
                                                </li>
                                            }
                                        }
                                        else
                                        {
                                            <li class="list-group-item text-center py-5 border-0">
                                                <div class="text-muted opacity-50 mb-3">
                                                    <i class="bi bi-receipt fs-1"></i>
                                                </div>
                                                <p class="text-muted mb-0">No recent transactions to show.</p>
                                            </li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Methods Tab -->
                        <div class="tab-pane fade" id="v-pills-methods" role="tabpanel" aria-labelledby="v-pills-methods-tab" tabindex="0">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="mb-0 fw-bold">My Cards</h4>
                                <a class="btn btn-primary rounded-pill" href='@Url.Action("AddPaymentMethod", "FinancialDashboard")'>
                                    <i class="bi bi-plus-lg me-2"></i>Add New Card
                                </a>
                            </div>
                            
                            <div class="row g-4">
                                @foreach (var method in Model.PaymentMethods)
                                {
                                    var brandClass = method.CardBrand?.ToLower().Contains("visa") == true ? "visa" : "mastercard";
                                    <div class="col-md-6 col-xl-4">
                                        <div class="payment-method-card @brandClass">
                                            <div class="d-flex justify-content-between">
                                                <div class="chip"></div>
                                                <i class="bi bi-wifi fs-4 opacity-75"></i>
                                            </div>
                                            <div class="card-number">
                                                @if(!string.IsNullOrEmpty(method.CardLast4Digit))
                                                {
                                                    <text>•••• •••• •••• @method.CardLast4Digit</text>
                                                }
                                                else
                                                {
                                                    <text>•••• •••• •••• ••••</text>
                                                }
                                            </div>
                                            <div class="d-flex justify-content-between align-items-end">
                                                <div>
                                                    <div class="small opacity-75" style="font-size: 0.7rem;">CARD HOLDER</div>
                                                    <div class="card-holder">@(string.IsNullOrEmpty(method.CardholderName) ? "VALUED MEMBER" : method.CardholderName)</div>
                                                </div>
                                                <div class="card-brand">
                                                    @if(brandClass == "visa") { <i class="bi bi-credit-card-2-front"></i> <span style="font-style: italic;">VISA</span> }
                                                    else if(brandClass == "mastercard") { <i class="bi bi-credit-card-2-back"></i> <span>Mastercard</span> }
                                                    else { @method.CardType }
                                                </div>
                                            </div>
                                            <a href='@Url.Action("CardDetails", "FinancialDashboard", new { id = method.Id })' class="stretched-link" aria-label="View card details"></a>
                                        </div>
                                    </div>
                                }
                                
                                <div class="col-md-6 col-xl-4">
                                    <a class="add-payment-card h-100 rounded-4 text-decoration-none d-flex flex-column" href='@Url.Action("AddPaymentMethod", "FinancialDashboard")'>
                                        <div class="rounded-circle bg-light p-3 mb-3 text-primary">
                                            <i class="bi bi-plus-lg fs-4"></i>
                                        </div>
                                        <span class="fw-medium">Add New Method</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Transaction History Tab -->
                        <div class="tab-pane fade" id="v-pills-history" role="tabpanel" aria-labelledby="v-pills-history-tab" tabindex="0">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="mb-0 fw-bold">Transaction History</h4>
                                <a asp-action="ExportTransactions" class="btn btn-outline-dark rounded-pill px-4"><i class="bi bi-download me-2"></i>Export CSV</a>
                            </div>
                            
                            <div class="card border-0">
                                <div class="card-body p-0" id="transaction-history-container">
                                    <partial name="_TransactionHistoryTable" model="Model" />
                                </div>
                            </div>
                        </div>

                        <!-- Refunds Tab -->
                        <div class="tab-pane fade" id="v-pills-refunds" role="tabpanel" aria-labelledby="v-pills-refunds-tab" tabindex="0">
                            <h4 class="mb-4 fw-bold">Refund Center</h4>
                            
                            <div class="row g-4">
                                <div class="col-lg-12">
                                    <div class="card mb-4">
                                        <div class="card-header bg-transparent px-4 py-3">
                                            <h5 class="card-title mb-0 fw-bold">Request a New Refund</h5>
                                        </div>
                                        <div class="card-body p-4">
                                            @if (TempData["SuccessMessage"] != null)
                                            {
                                                <div class="alert alert-success d-flex align-items-center rounded-3"><i class="bi bi-check-circle-fill me-2 fs-5"></i> @TempData["SuccessMessage"]</div>
                                            }
                                            @if (TempData["ErrorMessage"] != null)
                                            {
                                                <div class="alert alert-danger d-flex align-items-center rounded-3"><i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i> @TempData["ErrorMessage"]</div>
                                            }
                                            <form asp-action="SubmitRefundRequest" method="post">
                                                <div class="row g-3">
                                                    <div class="col-md-12">
                                                        <label for="refundRideId" class="form-label fw-medium">Select Eligible Ride</label>
                                                        <select class="form-select form-select-lg" id="refundRideId" name="rideId" required>
                                                            <option selected disabled value="">Choose a completed ride...</option>
                                                            @if (Model.CompletedRides != null)
                                                            {
                                                                foreach (var ride in Model.CompletedRides)
                                                                {
                                                                    <option value="@ride.Id">Ride #@ride.Id • @ride.Ride.Origin to @ride.Ride.Destination • @ride.BookingTime.ToString("MMM dd") • ₹@((ride.Ride.PricePerSeat * ride.BookedSeats * ride.DistanceKm).ToString("F2"))</option>
                                                                }
                                                            }
                                                        </select>
                                                        <div class="form-text">Only completed rides with successful payments are eligible for refunds.</div>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <label for="refundReason" class="form-label fw-medium">Reason for Refund</label>
                                                        <textarea class="form-control" id="refundReason" name="reason" rows="3" placeholder="Please describe the issue with your ride..." required></textarea>
                                                    </div>
                                                    <div class="col-12 text-end">
                                                        <button type="submit" class="btn btn-primary px-5 rounded-pill">Submit Request</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-lg-12">
                                    <div class="card">
                                        <div class="card-header bg-transparent px-4 py-3">
                                            <h5 class="card-title mb-0 fw-bold">Refund Requests History</h5>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="bg-light">
                                                    <tr>
                                                        <th class="ps-4 py-3 text-secondary text-uppercase small ls-1">Request ID</th>
                                                        <th class="py-3 text-secondary text-uppercase small ls-1">Date</th>
                                                        <th class="py-3 text-secondary text-uppercase small ls-1">Amount</th>
                                                        <th class="py-3 text-secondary text-uppercase small ls-1">Status</th>
                                                        <th class="pe-4 py-3 text-end text-secondary text-uppercase small ls-1">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (Model.Refunds != null && Model.Refunds.Any())
                                                    {
                                                        foreach (var refund in Model.Refunds)
                                                        {
                                                            <tr>
                                                                <td class="ps-4 fw-medium">REF-@(refund.Id + 1000)</td>
                                                                <td>@refund.ProcessedAt.ToString("MMM dd, yyyy")</td>
                                                                <td class="fw-bold">₹@refund.Amount.ToString("F2")</td>
                                                                <td>
                                                                    @if (refund.RefundStatus == "Completed")
                                                                    {
                                                                        <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3">Completed</span>
                                                                    }
                                                                    else if (refund.RefundStatus == "Processing")
                                                                    {
                                                                        <span class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle rounded-pill px-3">Processing</span>
                                                                    }
                                                                    else if (refund.RefundStatus == "Cancelled")
                                                                    {
                                                                        <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3">Cancelled</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill px-3">@refund.RefundStatus</span>
                                                                    }
                                                                </td>
                                                                <td class="text-end pe-4">
                                                                    <div class="d-inline-flex gap-2">
                                                                        <a asp-action="RefundDetails" asp-route-id="@refund.Id" class="btn btn-sm btn-outline-primary rounded-pill px-3">View</a>
                                                                        @if (refund.RefundStatus == "Processing")
                                                                        {
                                                                            <form asp-action="CancelRefundRequest" asp-route-id="@refund.Id" method="post" onsubmit="return confirm('Are you sure you want to cancel this request?');" style="display:inline;">
                                                                                <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-3">Cancel</button>
                                                                            </form>
                                                                        }
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <tr><td colspan="5" class="text-center py-5 text-muted">No refund requests found.</td></tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Removed as per request -->

    <!-- Add Money Modal -->
    <div class="modal fade" id="addMoneyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header bg-light border-0 pb-0">
                    <h5 class="modal-title fw-bold">Add Money to Wallet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form>
                        <div class="mb-4">
                            <label for="addAmount" class="form-label text-muted fw-medium small text-uppercase">Enter Amount</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-white border-end-0 text-muted">₹</span>
                                <input type="number" class="form-control border-start-0 ps-0 fw-bold" id="addAmount" placeholder="0.00" style="font-size: 1.5rem;">
                            </div>
                        </div>
                        <div class="d-flex gap-2 mb-4 overflow-auto pb-2">
                             <button type="button" class="btn btn-outline-secondary rounded-pill px-3" onclick="document.getElementById('addAmount').value=100">₹100</button>
                             <button type="button" class="btn btn-outline-secondary rounded-pill px-3" onclick="document.getElementById('addAmount').value=500">₹500</button>
                             <button type="button" class="btn btn-outline-secondary rounded-pill px-3" onclick="document.getElementById('addAmount').value=1000">₹1000</button>
                             <button type="button" class="btn btn-outline-secondary rounded-pill px-3" onclick="document.getElementById('addAmount').value=2000">₹2000</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 pt-0 pb-4 px-4">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="proceedPayBtn" class="btn btn-primary rounded-pill px-4 flex-grow-1">Proceed to Safe Pay</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Razorpay Checkout -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        const userId = @Model.Profile?.UserId ?? 0;
        const razorpayKey = '@ViewBag.RazorpayKey';
        document.getElementById('proceedPayBtn').addEventListener('click', () => {
            const amountInput = document.getElementById('addAmount');
            const amount = parseFloat(amountInput.value);
            if (!amount || amount <= 0) {
                alert("Please enter a valid amount");
                return;
            }

            const options = {
                key: razorpayKey,
                amount: Math.round(amount * 100), // convert to paise
                currency: 'INR',
                name: 'RideShare Connect',
                description: 'Wallet top-up',
                notes: { userId: userId.toString() },
                handler: function (response) {
                    alert('Payment successful: ' + response.razorpay_payment_id);
                    // You might want to reload the page here to reflect the new balance
                    // location.reload();
                },
                theme: {
                    color: '#ff6600'
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        });


        // AJAX Pagination for Transaction History
        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('transaction-history-container');
            
            container.addEventListener('click', function (e) {
                if (e.target.tagName === 'A' && e.target.classList.contains('ajax-pagination-link')) {
                    e.preventDefault();
                    // Add a simple loading state
                    container.style.opacity = '0.5';
                    
                    const url = e.target.getAttribute('href');
                    
                    fetch(url)
                        .then(response => response.text())
                        .then(html => {
                            container.innerHTML = html;
                            container.style.opacity = '1';
                        })
                        .catch(error => {
                            console.error('Error loading transactions:', error);
                            container.style.opacity = '1';
                        });
                }
            });
        });
    </script>
</body>
</html>
